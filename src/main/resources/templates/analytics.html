<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MiTienda - Analytics</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #ebebeb; }
        .header { background: #fff159; padding: 0.75rem 0; box-shadow: 0 1px 0 0 rgba(0,0,0,.1); }
        .header-content { max-width: 1200px; margin: 0 auto; padding: 0 1rem; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.8rem; font-weight: bold; color: #333; text-decoration: none; }
        .nav-links { display: flex; gap: 1rem; align-items: center; }
        .nav-links a { color: #333; text-decoration: none; font-size: 0.9rem; }
        .nav-links a:hover { text-decoration: underline; }
        .logout-btn { background: #666; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-size: 0.9rem; }
        .logout-btn:hover { background: #555; }
        .container { max-width: 1200px; margin: 1rem auto; padding: 0 1rem; }
        .analytics-title { background: white; padding: 1.5rem; border-radius: 4px; margin-bottom: 1rem; box-shadow: 0 1px 2px 0 rgba(0,0,0,.15); }
        .analytics-title h1 { color: #333; font-size: 1.8rem; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { background: white; padding: 1.5rem; border-radius: 4px; box-shadow: 0 1px 2px 0 rgba(0,0,0,.15); text-align: center; }
        .stat-value { font-size: 2rem; font-weight: bold; color: #3483fa; margin-bottom: 0.5rem; }
        .stat-label { color: #666; font-size: 0.9rem; }
        .sales-section { background: white; padding: 2rem; border-radius: 4px; box-shadow: 0 1px 2px 0 rgba(0,0,0,.15); }
        .sales-section h2 { color: #333; margin-bottom: 1.5rem; font-size: 1.3rem; }
        .sales-table { width: 100%; border-collapse: collapse; }
        .sales-table th, .sales-table td { padding: 1rem; text-align: left; border-bottom: 1px solid #f5f5f5; }
        .sales-table th { background: #f8f9fa; font-weight: 600; color: #333; font-size: 0.9rem; }
        .sales-table td { font-size: 0.9rem; }
        .order-status { padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.8rem; font-weight: 500; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-confirmed { background: #d1ecf1; color: #0c5460; }
        .status-delivered { background: #d4edda; color: #155724; }
        .status-cancelled { background: #f8d7da; color: #721c24; }
        .loading { text-align: center; padding: 3rem; color: #666; }
        .order-row { cursor: pointer; }
        .order-row:hover { background: #f8f9fa; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 5% auto; padding: 2rem; width: 80%; max-width: 800px; border-radius: 8px; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 1px solid #e6e6e6; padding-bottom: 1rem; }
        .modal-title { font-size: 1.5rem; color: #333; }
        .close { font-size: 2rem; cursor: pointer; color: #666; }
        .close:hover { color: #333; }
        .order-info { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 2rem; }
        .info-item { background: #f8f9fa; padding: 1rem; border-radius: 4px; }
        .info-label { font-weight: bold; color: #666; font-size: 0.9rem; margin-bottom: 0.5rem; }
        .info-value { color: #333; font-size: 1rem; }
        .items-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .items-table th, .items-table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #e6e6e6; }
        .items-table th { background: #f8f9fa; font-weight: 600; }
        .product-image { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <a href="/shop" class="logo">MiTienda</a>
            <div class="nav-links">
                <a href="/admin">Gestión Productos</a>
                <a href="/shop">Ver tienda</a>
                <button class="logout-btn" onclick="logout()">Salir</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="analytics-title">
            <h1>Analytics y Ventas</h1>
            <p style="color: #666; margin-top: 0.5rem;">Panel de control de ventas e ingresos</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalRevenue">$0</div>
                <div class="stat-label">Ingresos Totales</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalOrders">0</div>
                <div class="stat-label">Órdenes Completadas</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalCustomers">0</div>
                <div class="stat-label">Clientes Únicos</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="averageOrder">$0</div>
                <div class="stat-label">Valor Promedio por Orden</div>
            </div>
        </div>

        <div class="sales-section">
            <h2>Historial de Ventas</h2>
            <div id="loading" class="loading">Cargando datos...</div>
            <table class="sales-table" id="salesTable" style="display: none;">
                <thead>
                    <tr>
                        <th>ID Orden</th>
                        <th>Cliente</th>
                        <th>Fecha</th>
                        <th>Total</th>
                        <th>Estado</th>
                        <th>Productos</th>
                        <th>Acción</th>
                    </tr>
                </thead>
                <tbody id="salesTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal para detalle de orden -->
    <div id="orderModal" class="modal">
        <div class="modal-content" id="modalContent">
            <!-- Contenido del modal se carga dinámicamente -->
        </div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        
        if (!token) {
            window.location.href = '/';
        }

        checkAdminAccess();
        loadAnalytics();
        loadSales();

        async function checkAdminAccess() {
            try {
                const response = await fetch('/api/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const userData = JSON.parse(await response.text());
                    if (userData.role !== 'ADMIN') {
                        alert('No tienes permisos de administrador');
                        window.location.href = '/';
                    }
                } else {
                    window.location.href = '/';
                }
            } catch (error) {
                window.location.href = '/';
            }
        }

        async function loadAnalytics() {
            try {
                const response = await fetch('/api/admin/analytics', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const analytics = await response.json();
                    document.getElementById('totalRevenue').textContent = '$' + analytics.totalRevenue.toFixed(2);
                    document.getElementById('totalOrders').textContent = analytics.totalOrders;
                    document.getElementById('totalCustomers').textContent = analytics.totalCustomers;
                    document.getElementById('averageOrder').textContent = '$' + analytics.averageOrderValue.toFixed(2);
                }
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        async function loadSales() {
            try {
                console.log('Cargando ventas...');
                const response = await fetch('/api/admin/sales', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                console.log('Response status:', response.status);
                
                if (response.ok) {
                    const sales = await response.json();
                    console.log('Sales data:', sales);
                    displaySales(sales);
                } else {
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    throw new Error('Error al cargar ventas: ' + response.status);
                }
            } catch (error) {
                console.error('Error loading sales:', error);
                document.getElementById('loading').textContent = 'Error al cargar las ventas: ' + error.message;
            }
        }

        function displaySales(sales) {
            console.log('Mostrando ventas:', sales);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('salesTable').style.display = 'table';
            
            const tbody = document.getElementById('salesTableBody');
            
            if (!sales || sales.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: #666;">No hay ventas registradas</td></tr>';
                return;
            }
            
            tbody.innerHTML = sales.map(order => {
                const date = new Date(order.orderDate).toLocaleDateString('es-ES');
                const statusClass = `status-${order.status.toLowerCase()}`;
                const itemsCount = order.items ? order.items.length : 0;
                const displayName = order.user ? (order.user.displayName || order.user.username) : 'Usuario desconocido';
                
                return `
                    <tr class="order-row" onclick="showOrderDetail(${order.id})">
                        <td>#${order.id}</td>
                        <td>${displayName}</td>
                        <td>${date}</td>
                        <td>$${order.totalAmount.toFixed(2)}</td>
                        <td><span class="order-status ${statusClass}">${order.status}</span></td>
                        <td>${itemsCount} producto(s)</td>
                        <td><span style="color: #3483fa; font-size: 0.9rem;">👁️ Ver detalle</span></td>
                    </tr>
                `;
            }).join('');
        }

        async function showOrderDetail(orderId) {
            try {
                console.log('Cargando detalle de orden:', orderId);
                const response = await fetch(`/api/admin/orders/${orderId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                console.log('Response status:', response.status);
                
                if (response.ok) {
                    const order = await response.json();
                    console.log('Order detail:', order);
                    displayOrderModal(order);
                } else {
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    alert('Error al cargar detalle de la orden: ' + response.status);
                }
            } catch (error) {
                console.error('Error loading order detail:', error);
                alert('Error de conexión: ' + error.message);
            }
        }
        
        function displayOrderModal(order) {
            try {
                console.log('Displaying modal for order:', order);
                const date = new Date(order.orderDate).toLocaleString('es-ES');
                const displayName = order.user ? (order.user.displayName || order.user.username) : 'Usuario desconocido';
                
                let itemsHtml = '';
                if (order.items && order.items.length > 0) {
                    itemsHtml = order.items.map(item => `
                        <tr>
                            <td><img src="${item.product.image}" alt="${item.product.name}" class="product-image"></td>
                            <td>${item.product.name}</td>
                            <td>${item.quantity}</td>
                            <td>$${item.unitPrice.toFixed(2)}</td>
                            <td>$${(item.quantity * item.unitPrice).toFixed(2)}</td>
                        </tr>
                    `).join('');
                } else {
                    itemsHtml = '<tr><td colspan="5" style="text-align: center; padding: 1rem;">No hay productos en esta orden</td></tr>';
                }
            
            const modalHtml = `
                <div class="modal-header">
                    <h2 class="modal-title">Detalle de Orden #${order.id}</h2>
                    <span class="close" onclick="closeModal()">&times;</span>
                </div>
                <div class="order-info">
                    <div class="info-item">
                        <div class="info-label">Cliente</div>
                        <div class="info-value">${displayName}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Email</div>
                        <div class="info-value">${order.user.email}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Fecha de Orden</div>
                        <div class="info-value">${date}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Estado</div>
                        <div class="info-value"><span class="order-status status-${order.status.toLowerCase()}">${order.status}</span></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Total de Productos</div>
                        <div class="info-value">${order.items.length} producto(s)</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Total a Pagar</div>
                        <div class="info-value" style="font-size: 1.2rem; font-weight: bold; color: #28a745;">$${order.totalAmount.toFixed(2)}</div>
                    </div>
                </div>
                <h3 style="margin-bottom: 1rem; color: #333;">Productos Ordenados</h3>
                <table class="items-table">
                    <thead>
                        <tr>
                            <th>Imagen</th>
                            <th>Producto</th>
                            <th>Cantidad</th>
                            <th>Precio Unitario</th>
                            <th>Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemsHtml}
                    </tbody>
                </table>
            `;
            
                document.getElementById('modalContent').innerHTML = modalHtml;
                document.getElementById('orderModal').style.display = 'block';
            } catch (error) {
                console.error('Error displaying modal:', error);
                alert('Error al mostrar el detalle de la orden');
            }
        }
        
        function closeModal() {
            document.getElementById('orderModal').style.display = 'none';
        }
        
        // Cerrar modal al hacer clic fuera
        window.onclick = function(event) {
            const modal = document.getElementById('orderModal');
            if (event.target === modal) {
                closeModal();
            }
        }
        
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('cart');
            window.location.href = '/';
        }
    </script>
</body>
</html>